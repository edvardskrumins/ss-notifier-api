{{- if .Values.filebeat.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ss-notifier-api.name" . }}-filebeat-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "ss-notifier-api.labels" . | nindent 4 }}
    component: filebeat
data:
  filebeat.yml: |
    filebeat.inputs:
      - type: filestream
        id: laravel-logs
        enabled: true
        paths:
          - /var/www/html/storage/logs/laravel.log*
        exclude_files: ['worker.log*', 'cron.log*', 'api.log*']
        parsers:
          - ndjson:
              keys_under_root: true
              add_error_key: true
              message_key: message
        fields:
          log_type: app
          source: laravel
          environment: {{ .Values.environment | default "production" }}
        fields_under_root: true
        tags: ["laravel", "application"]
        scan_frequency: 10s

      - type: filestream
        id: worker-logs
        enabled: true
        paths:
          - /var/www/html/storage/logs/worker.log*
        parsers:
          - ndjson:
              keys_under_root: true
              add_error_key: true
              message_key: message
        fields:
          log_type: worker
          source: queue
        fields_under_root: true
        tags: ["worker", "queue"]
        scan_frequency: 10s

      - type: filestream
        id: api-logs
        enabled: true
        paths:
          - /var/www/html/storage/logs/api.log*
        parsers:
          - ndjson:
              keys_under_root: true
              add_error_key: true
              message_key: message
        fields:
          log_type: api
          source: http
        fields_under_root: true
        tags: ["api", "http"]
        scan_frequency: 10s

    output.elasticsearch:
      hosts: ["https://{{ include "ss-notifier-api.name" . }}-elasticsearch-es-http:9200"]
      username: ${ELASTICSEARCH_USERNAME}
      password: ${ELASTICSEARCH_PASSWORD}
      ssl:
        enabled: true
        verification_mode: certificate
        certificate_authorities:
          - /usr/share/filebeat/certs/ca.crt
      indices:
        - index: "app-logs-%{+yyyy.MM.dd}"
          when.equals:
            log_type: app
        - index: "worker-logs-%{+yyyy.MM.dd}"
          when.equals:
            log_type: worker
        - index: "api-logs-%{+yyyy.MM.dd}"
          when.equals:
            log_type: api

    processors:
      - add_host_metadata:
          when.not.contains.tags: forwarded
{{- end }}

